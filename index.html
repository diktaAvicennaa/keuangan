<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pencatat Keuangan Online</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js - Loaded directly for browser compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      /* Apply the Inter font to the whole page */
      body {
        font-family: "Inter", sans-serif;
        background-color: #f3f4f6;
      }
      /* Custom scrollbar for a better look */
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: #f1f1f1;
      }
      ::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: #555;
      }
      /* Loading Spinner */
      .loader {
        border: 5px solid #f3f3f3;
        border-radius: 50%;
        border-top: 5px solid #3498db;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body class="p-4 md:p-8">
    <!-- Loading overlay -->
    <div
      id="loading-overlay"
      class="fixed inset-0 bg-gray-800 bg-opacity-75 flex flex-col items-center justify-center z-50"
    >
      <div class="loader"></div>
      <p class="text-white text-lg mt-4">Menghubungkan ke server...</p>
    </div>

    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Kolom Kiri: Input & Ringkasan -->
      <div class="lg:col-span-1 flex flex-col gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-md">
          <h1 class="text-2xl font-bold text-gray-800">
            Pencatat Keuangan Online
          </h1>
          <p id="user-id-display" class="text-gray-500 mt-2 text-xs break-all">
            ID Pengguna Anda: <span class="font-semibold">memuat...</span>
          </p>
        </div>

        <!-- Card Ringkasan Keuangan -->
        <div class="bg-white p-6 rounded-2xl shadow-md">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">Ringkasan</h2>
          <div class="space-y-4">
            <div
              class="flex justify-between items-center p-4 bg-green-50 rounded-lg"
            >
              <span class="font-medium text-green-800">Pendapatan</span>
              <span
                id="total-pendapatan"
                class="font-bold text-lg text-green-600"
                >Rp 0</span
              >
            </div>
            <div
              class="flex justify-between items-center p-4 bg-red-50 rounded-lg"
            >
              <span class="font-medium text-red-800">Pengeluaran</span>
              <span
                id="total-pengeluaran"
                class="font-bold text-lg text-red-600"
                >Rp 0</span
              >
            </div>
            <div
              class="flex justify-between items-center p-4 bg-blue-50 rounded-lg"
            >
              <span class="font-medium text-blue-800">Saldo Akhir</span>
              <span id="saldo-akhir" class="font-bold text-lg text-blue-600"
                >Rp 0</span
              >
            </div>
          </div>
        </div>

        <!-- Card Form Input Transaksi -->
        <div class="bg-white p-6 rounded-2xl shadow-md">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">
            Tambah Transaksi Baru
          </h2>
          <form id="transaction-form" class="space-y-4">
            <div>
              <label
                for="keterangan"
                class="block text-sm font-medium text-gray-600"
                >Keterangan</label
              >
              <input
                type="text"
                id="keterangan"
                placeholder="Contoh: Gaji bulanan"
                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                required
              />
            </div>
            <div>
              <label
                for="jumlah"
                class="block text-sm font-medium text-gray-600"
                >Jumlah (Rp)</label
              >
              <input
                type="number"
                id="jumlah"
                placeholder="Contoh: 5000000"
                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                required
              />
            </div>
            <div>
              <label for="tipe" class="block text-sm font-medium text-gray-600"
                >Tipe Transaksi</label
              >
              <select
                id="tipe"
                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="pendapatan">Pendapatan</option>
                <option value="pengeluaran">Pengeluaran</option>
              </select>
            </div>
            <div>
              <label
                for="kategori"
                class="block text-sm font-medium text-gray-600"
                >Kategori</label
              >
              <select
                id="kategori"
                class="mt-1 block w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="Gaji">Gaji</option>
                <option value="Makanan & Minuman">Makanan & Minuman</option>
                <option value="Transportasi">Transportasi</option>
                <option value="Tagihan">Tagihan</option>
                <option value="Hiburan">Hiburan</option>
                <option value="Belanja">Belanja</option>
                <option value="Kesehatan">Kesehatan</option>
                <option value="Lainnya">Lainnya</option>
              </select>
            </div>
            <button
              type="submit"
              class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300"
            >
              Tambahkan
            </button>
          </form>
        </div>
      </div>

      <!-- Kolom Kanan: Daftar Transaksi & Grafik -->
      <div class="lg:col-span-2 flex flex-col gap-8">
        <div class="bg-white p-6 rounded-2xl shadow-md">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">
            Riwayat Transaksi
          </h2>
          <div class="overflow-x-auto max-h-[400px]">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Keterangan
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Jumlah
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Kategori
                  </th>
                  <th
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Aksi
                  </th>
                </tr>
              </thead>
              <tbody
                id="transaction-list"
                class="bg-white divide-y divide-gray-200"
              >
                <tr id="placeholder-row">
                  <td colspan="4" class="px-6 py-4 text-center text-gray-500">
                    Belum ada transaksi.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-md">
          <h2 class="text-xl font-semibold text-gray-700 mb-4">
            Grafik Komposisi Pengeluaran
          </h2>
          <div class="w-full h-64 md:h-80 flex items-center justify-center">
            <canvas id="expense-chart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-analytics.js";
      const firebaseConfig = {
        apiKey: "AIzaSyBAdKlekDsHUe1n8BL9rjxZFZjmbAh9_ro",
        authDomain: "keuangan-saya-620fd.firebaseapp.com",
        projectId: "keuangan-saya-620fd",
        storageBucket: "keuangan-saya-620fd.appspot.com",
        messagingSenderId: "807499290917",
        appId: "1:807499290917:web:3232b5b35235f6fcb6e2cc",
        measurementId: "G-SL1ER5MLNL",
      };
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
    </script>
    <script type="module">
      // Import fungsi-fungsi yang diperlukan dari Firebase SDK
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        addDoc,
        onSnapshot,
        deleteDoc,
        doc,
        query,
        serverTimestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Variabel global
      let db, auth;
      let currentUser = null;
      let transactionsCollection;
      let unsubscribe; // Untuk listener onSnapshot

      // Elemen DOM
      const loadingOverlay = document.getElementById("loading-overlay");
      const form = document.getElementById("transaction-form");
      const keteranganInput = document.getElementById("keterangan");
      const jumlahInput = document.getElementById("jumlah");
      const tipeInput = document.getElementById("tipe");
      const kategoriInput = document.getElementById("kategori");
      const transactionList = document.getElementById("transaction-list");
      const totalPendapatanEl = document.getElementById("total-pendapatan");
      const totalPengeluaranEl = document.getElementById("total-pengeluaran");
      const saldoAkhirEl = document.getElementById("saldo-akhir");
      const userIdDisplay = document.getElementById("user-id-display");

      // Chart.js initialization (Chart is available globally from the script tag in <head>)
      const ctx = document.getElementById("expense-chart").getContext("2d");
      let expenseChart = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: [],
          datasets: [
            {
              label: "Pengeluaran per Kategori",
              data: [],
              backgroundColor: [
                "#ef4444",
                "#f97316",
                "#eab308",
                "#84cc16",
                "#22c55e",
                "#14b8a6",
                "#06b6d4",
                "#3b82f6",
                "#8b5cf6",
                "#d946ef",
              ],
              borderColor: "#ffffff",
              borderWidth: 2,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: "right" },
            tooltip: {
              callbacks: {
                label: (context) => {
                  let label = context.label || "";
                  if (label) label += ": ";
                  if (context.parsed !== null) {
                    const total = context.chart.data.datasets[0].data.reduce(
                      (a, b) => a + b,
                      0
                    );
                    const percentage =
                      total > 0
                        ? ((context.parsed / total) * 100).toFixed(2) + "%"
                        : "0%";
                    label += formatRupiah(context.parsed) + ` (${percentage})`;
                  }
                  return label;
                },
              },
            },
          },
        },
      });

      // --- FUNGSI UTAMA ---

      // Fungsi inisialisasi Firebase
      async function initializeFirebase() {
        try {
          // Konfigurasi Firebase akan otomatis diisi oleh environment
          const firebaseConfig = {
            apiKey: "AIzaSyBAdKlekDsHUe1n8BL9rjxZFZjmbAh9_ro",
            authDomain: "keuangan-saya-620fd.firebaseapp.com",
            projectId: "keuangan-saya-620fd",
            storageBucket: "keuangan-saya-620fd.appspot.com",
            messagingSenderId: "807499290917",
            appId: "1:807499290917:web:3232b5b35235f6fcb6e2cc",
            measurementId: "G-SL1ER5MLNL",
          };
          const appId =
            typeof __app_id !== "undefined" ? __app_id : "default-app-id";

          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // Autentikasi pengguna
          onAuthStateChanged(auth, async (user) => {
            if (user) {
              currentUser = user;
              console.log("User signed in:", currentUser.uid);
              userIdDisplay.querySelector("span").textContent = currentUser.uid;
              await setupDataListener(); // Mulai mendengarkan data setelah login
            } else {
              console.log("No user signed in. Attempting to sign in...");
              // Jika ada token, gunakan. Jika tidak, sign in secara anonim.
              if (
                typeof __initial_auth_token !== "undefined" &&
                __initial_auth_token
              ) {
                await signInWithCustomToken(auth, __initial_auth_token);
              } else {
                await signInAnonymously(auth);
              }
            }
          });
        } catch (error) {
          console.error("Firebase initialization failed:", error);
          loadingOverlay.innerHTML =
            '<p class="text-white text-lg text-center">Gagal terhubung ke server.<br>Silakan refresh halaman.</p>';
        }
      }

      // Fungsi untuk setup listener data real-time
      async function setupDataListener() {
        if (!currentUser) return;

        // Hentikan listener lama jika ada
        if (unsubscribe) unsubscribe();

        // Tentukan path koleksi berdasarkan user ID
        const collectionPath = `/artifacts/${
          typeof __app_id !== "undefined" ? __app_id : "default-app-id"
        }/users/${currentUser.uid}/transactions`;
        transactionsCollection = collection(db, collectionPath);
        const q = query(transactionsCollection);

        // Listener onSnapshot untuk update real-time
        unsubscribe = onSnapshot(
          q,
          (querySnapshot) => {
            const transactions = [];
            querySnapshot.forEach((doc) => {
              transactions.push({ id: doc.id, ...doc.data() });
            });

            // Urutkan transaksi berdasarkan waktu pembuatan
            transactions.sort(
              (a, b) =>
                (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0)
            );

            renderUI(transactions);
            loadingOverlay.style.display = "none"; // Sembunyikan loading setelah data pertama diterima
          },
          (error) => {
            console.error("Error listening to data:", error);
            loadingOverlay.innerHTML =
              '<p class="text-white text-lg">Gagal memuat data.</p>';
          }
        );
      }

      // Fungsi untuk merender ulang seluruh UI
      function renderUI(transactions) {
        renderTransactionList(transactions);
        updateSummary(transactions);
        updateChart(transactions);
      }

      // Fungsi untuk menambahkan transaksi baru
      async function addTransaction(e) {
        e.preventDefault();
        if (
          keteranganInput.value.trim() === "" ||
          jumlahInput.value.trim() === "" ||
          !currentUser
        ) {
          alert("Mohon isi semua field dan pastikan Anda terhubung.");
          return;
        }

        try {
          await addDoc(transactionsCollection, {
            keterangan: keteranganInput.value,
            jumlah: +jumlahInput.value,
            tipe: tipeInput.value,
            kategori: kategoriInput.value,
            createdAt: serverTimestamp(), // Tambahkan timestamp server
          });
          form.reset(); // Reset form setelah berhasil
        } catch (error) {
          console.error("Error adding document: ", error);
          alert("Gagal menambahkan transaksi. Silakan coba lagi.");
        }
      }

      // Fungsi untuk menghapus transaksi
      async function removeTransaction(id) {
        if (!currentUser) return;
        if (confirm("Apakah Anda yakin ingin menghapus transaksi ini?")) {
          try {
            const docRef = doc(transactionsCollection, id);
            await deleteDoc(docRef);
          } catch (error) {
            console.error("Error removing document: ", error);
            alert("Gagal menghapus transaksi.");
          }
        }
      }

      // --- FUNGSI PEMBANTU (RENDERING) ---

      // Render daftar transaksi di tabel
      function renderTransactionList(transactions) {
        transactionList.innerHTML = "";
        if (transactions.length === 0) {
          transactionList.innerHTML = `
                    <tr id="placeholder-row">
                       <td colspan="4" class="px-6 py-4 text-center text-gray-500">Belum ada transaksi.</td>
                    </tr>`;
          return;
        }
        transactions.forEach((transaction) => {
          const item = document.createElement("tr");
          const isPendapatan = transaction.tipe === "pendapatan";
          item.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap"><div class="text-sm font-medium text-gray-900">${
                      transaction.keterangan
                    }</div></td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="text-sm font-semibold ${
                      isPendapatan ? "text-green-600" : "text-red-600"
                    }">${isPendapatan ? "+" : "-"} ${formatRupiah(
            transaction.jumlah
          )}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                      isPendapatan
                        ? "bg-green-100 text-green-800"
                        : "bg-yellow-100 text-yellow-800"
                    }">${transaction.kategori}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium"><button data-id="${
                      transaction.id
                    }" class="remove-btn text-red-500 hover:text-red-700">Hapus</button></td>
                `;
          transactionList.appendChild(item);
        });
      }

      // Update ringkasan keuangan
      function updateSummary(transactions) {
        const pendapatan = transactions
          .filter((t) => t.tipe === "pendapatan")
          .reduce((acc, t) => acc + t.jumlah, 0);
        const pengeluaran = transactions
          .filter((t) => t.tipe === "pengeluaran")
          .reduce((acc, t) => acc + t.jumlah, 0);
        const saldo = pendapatan - pengeluaran;

        totalPendapatanEl.innerText = formatRupiah(pendapatan);
        totalPengeluaranEl.innerText = formatRupiah(pengeluaran);
        saldoAkhirEl.innerText = formatRupiah(saldo);
      }

      // Update grafik pengeluaran
      function updateChart(transactions) {
        const expenseByCategory = transactions
          .filter((t) => t.tipe === "pengeluaran")
          .reduce((acc, t) => {
            acc[t.kategori] = (acc[t.kategori] || 0) + t.jumlah;
            return acc;
          }, {});

        expenseChart.data.labels = Object.keys(expenseByCategory);
        expenseChart.data.datasets[0].data = Object.values(expenseByCategory);
        expenseChart.update();
      }

      function formatRupiah(angka) {
        return new Intl.NumberFormat("id-ID", {
          style: "currency",
          currency: "IDR",
          minimumFractionDigits: 0,
        }).format(angka);
      }

      // --- EVENT LISTENERS ---

      form.addEventListener("submit", addTransaction);

      // Event delegation untuk tombol hapus
      transactionList.addEventListener("click", (e) => {
        if (e.target.classList.contains("remove-btn")) {
          const id = e.target.getAttribute("data-id");
          removeTransaction(id);
        }
      });

      // Jalankan inisialisasi
      initializeFirebase();
    </script>
  </body>
</html>
